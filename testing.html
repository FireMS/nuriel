<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }
        /* Light Mode Styles (default) */
        .window {
            width: 400px;
            height: 300px;
            border: 2px solid black;
            background-color: #C0C0C0;
            position: absolute;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .window-header {
            background-color: #0066CC;
            color: white;
            padding: 10px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .window-content {
            background-color: white;
            height: calc(100% - 40px);
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
        }
        .resizer {
            width: 10px;
            height: 10px;
            background-color: #0066CC;
            position: absolute;
            bottom: 0;
            right: 0;
            cursor: se-resize;
        }
        .draggable {
            width: 64px;
            height: 64px;
            position: absolute;
            background-size: cover;
            user-select: none;
        }
        .text {
            position: absolute;
            text-align: center;
            font-family: 'Comic Sans MS', cursive;
            user-select: none;
        }
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #2C2C2C;
            color: white;
        }
        .window.dark-mode {
            background-color: #333;
            border-color: #555;
        }
        .window-header.dark-mode {
            background-color: #444;
            color: #ccc;
        }
        .window-content.dark-mode {
            background-color: #555;
            color: #ddd;
        }
        .resizer.dark-mode {
            background-color: #444;
        }
        .draggable.dark-mode {
            background-color: #555;
        }
        /* Dark mode toggle button */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #0066CC;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }
        .dark-mode-toggle:hover {
            background-color: #004D99;
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <div class="mobile-message" id="mobileMessage">Mobile not supported yet, sorry :(</div>

    <!-- Journal 1 -->
    <div class="draggable" id="draggable1"></div>
    <div class="text" id="text1">placeholder</div>

    <!-- Journal 2 -->
    <div class="draggable" id="draggable2"></div>
    <div class="text" id="text2">dialogue</div>

    <script>
        const imageUrls = ['https://raw.githubusercontent.com/FireMS/nuriel/main/journals/journal.png'];
        const draggables = [
            document.getElementById('draggable1'),
            document.getElementById('draggable2')
        ];
        const texts = [
            document.getElementById('text1'),
            document.getElementById('text2')
        ];
        let isDraggingWindow = false;
        let journalStates = [false, false];

        //mobile check
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            document.getElementById('mobileMessage').style.display = 'flex';
        } else {
            document.getElementById('mobileMessage').style.display = 'none';
        }

        for (let i = 0; i < draggables.length; i++) {
            draggables[i].style.backgroundImage = `url(${imageUrls[0]})`;
            loadPosition(i); // load position from cookie
            draggables[i].addEventListener('dblclick', (event) => openJournalWindow(event, i));
            draggables[i].addEventListener('mousedown', (event) => {
                if (!isDraggingWindow) dragStart(event, i);
            });
        }

        // Load position from localStorage
        function loadPosition(id) {
            const savedPosition = JSON.parse(localStorage.getItem(`folder${id}Position`));
            if (savedPosition) {
                draggables[id].style.left = savedPosition.x + 'px';
                draggables[id].style.top = savedPosition.y + 'px';
                updateTextPosition(draggables[id], texts[id]);
            } else {
                let randomX = Math.floor(Math.random() * (window.innerWidth - 100));
                let randomY = Math.floor(Math.random() * (window.innerHeight - 90));
                draggables[id].style.left = randomX + 'px';
                draggables[id].style.top = randomY + 'px';
                updateTextPosition(draggables[id], texts[id]);
            }
        }

        // Save position to localStorage
        function savePosition(id) {
            const position = {
                x: parseInt(draggables[id].style.left),
                y: parseInt(draggables[id].style.top)
            };
            localStorage.setItem(`folder${id}Position`, JSON.stringify(position));
        }

        // open journal in a draggable window
        function openJournalWindow(event, id) {
            if (journalStates[id]) return;
            journalStates[id] = true;

            const urls = [
                `https://nuriel.net/journals/6.21.24.txt`,
                `https://nuriel.net/journals/dialogue.txt`
            ];

            const newWindow = document.createElement('div');
            newWindow.className = 'window';
            document.body.appendChild(newWindow);

            const header = document.createElement('div');
            header.className = 'window-header';

            const title = document.createElement('span');
            title.innerText = `entry - ${texts[id].innerText}`;
            header.appendChild(title);

            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-btn';
            closeBtn.innerText = 'X';
            closeBtn.onclick = () => {
                document.body.removeChild(newWindow);
                journalStates[id] = false;
            };
            header.appendChild(closeBtn);

            newWindow.appendChild(header);

            const content = document.createElement('div');
            content.className = 'window-content';
            newWindow.appendChild(content);

            const resizer = document.createElement('div');
            resizer.className = 'resizer';
            newWindow.appendChild(resizer);

            fetch(urls[id])
                .then(response => response.text())
                .then(text => {
                    content.innerText = text;
                });

            let offsetX = 0, offsetY = 0;
            header.onmousedown = (e) => {
                isDraggingWindow = true;
                offsetX = e.clientX - newWindow.getBoundingClientRect().left;
                offsetY = e.clientY - newWindow.getBoundingClientRect().top;
                document.onmousemove = (e) => {
                    newWindow.style.left = e.clientX - offsetX + 'px';
                    newWindow.style.top = e.clientY - offsetY + 'px';
                };
                document.onmouseup = () => {
                    isDraggingWindow = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };

            let isResizing = false;
            resizer.onmousedown = (e) => {
                isResizing = true;
                document.onmousemove = (e) => {
                    if (isResizing) {
                        const newWidth = e.clientX - newWindow.getBoundingClientRect().left;
                        const newHeight = e.clientY - newWindow.getBoundingClientRect().top;
                        newWindow.style.width = newWidth + 'px';
                        newWindow.style.height = newHeight + 'px';
                    }
                };
                document.onmouseup = () => {
                    isResizing = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
        }

        let offsets = {};
        let isDragging = [];

        function dragStart(event, id) {
            isDragging[id] = true;
            const rect = draggables[id].getBoundingClientRect();
            offsets[id] = { x: event.clientX - rect.left, y: event.clientY - rect.top };
        }

        document.addEventListener('mousemove', (event) => {
            for (let i = 0; i < draggables.length; i++) {
                if (isDragging[i]) {
                    let newX = event.clientX - offsets[i].x;
                    let newY = event.clientY - offsets[i].y;
                    newX = Math.max(0, Math.min(newX, window.innerWidth - 64));
                    newY = Math.max(0, Math.min(newY, window.innerHeight - 64));
                    draggables[i].style.left = newX + 'px';
                    draggables[i].style.top = newY + 'px';
                    updateTextPosition(draggables[i], texts[i]);
                }
            }
        });

        document.addEventListener('mouseup', () => {
            for (let i = 0; i < draggables.length; i++) {
                if (isDragging[i]) {
                    isDragging[i] = false;
                    savePosition(i);
                }
            }
        });

        // Update text relative to journals
        function updateTextPosition(draggable, text) {
            const folderRect = draggable.getBoundingClientRect();
            const textLeft = folderRect.left + (folderRect.width - text.offsetWidth) / 2;
            text.style.left = textLeft + 'px';
            text.style.top = folderRect.bottom + 'px';
        }

        // Toggle Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const windows = document.querySelectorAll('.window');
            windows.forEach(window => window.classList.toggle('dark-mode'));
            const draggables = document.querySelectorAll('.draggable');
            draggables.forEach(draggable => draggable.classList.toggle('dark-mode'));
        }
    </script>
</body>
</html>
